<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Train Times" />
  <title>Train Times - Palmers Green</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media (display-mode: standalone) {
      body { padding-top: env(safe-area-inset-top); }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="max-w-2xl mx-auto p-4">
    <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
          <h1 class="text-2xl font-bold text-gray-800">Palmers Green Train Times</h1>
        </div>
        <button onclick="fetchTrains()" id="refreshBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
          <svg id="refreshIcon" class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
        </button>
      </div>

      <div class="flex gap-2 mb-4">
        <button onclick="setMode('out')" id="outBtn"
          class="flex-1 py-3 px-4 rounded-lg font-semibold transition-all bg-indigo-600 text-white shadow-md">
          OUT
        </button>
        <button onclick="setMode('home')" id="homeBtn"
          class="flex-1 py-3 px-4 rounded-lg font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300">
          HOME
        </button>
      </div>

      <div class="text-sm text-gray-600 mb-3">
        <div id="routeInfo" class="font-semibold">Palmers Green â†’ Moorgate</div>
        <div id="walkingTime" class="text-xs text-indigo-600 font-medium mt-1 hidden"></div>
        <div class="flex items-center gap-2 mt-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          <span id="lastUpdate">Loading...</span>
        </div>
      </div>

      <div class="flex items-center gap-3 flex-wrap">
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" id="autoRefresh" checked class="w-4 h-4 text-indigo-600 rounded">
          <span class="text-sm text-gray-700">Auto-refresh</span>
        </label>
        <button onclick="requestNotifications()" id="notifyBtn"
          class="text-sm text-indigo-600 hover:text-indigo-700 font-medium">
          ðŸ”” Enable alerts
        </button>
      </div>
    </div>

    <div id="statusMessage" class="mb-4 hidden"></div>

    <div id="trainList" class="space-y-3">
      <div class="bg-white rounded-lg shadow-md p-8 text-center text-gray-500">
        Click refresh to load train times
      </div>
    </div>
  </div>

  <script>
    let autoRefreshInterval;
    let currentMode = 'out';
    let userLocation = null;

    const PALMERS_GREEN = { code: 'PAL', name: 'Palmers Green', lat: 51.6176, lon: -0.1116 };
    const MOORGATE = { code: 'MOG', name: 'Moorgate' };

    const GREAT_NORTHERN_STATIONS = [
      { code: 'MOG', name: 'Moorgate', lat: 51.5188, lon: -0.0886 },
      { code: 'FPK', name: 'Finsbury Park', lat: 51.5642, lon: -0.1065 },
      { code: 'ALX', name: 'Alexandra Palace', lat: 51.5978, lon: -0.1197 },
      { code: 'BVP', name: 'Bowes Park', lat: 51.6021, lon: -0.1196 },
      { code: 'WGC', name: 'Winchmore Hill', lat: 51.6341, lon: -0.1008 },
      { code: 'GAN', name: 'Grange Park', lat: 51.6414, lon: -0.1044 }
    ];

    function setMode(mode) {
      currentMode = mode;
      const outBtn = document.getElementById('outBtn');
      const homeBtn = document.getElementById('homeBtn');
      if (mode === 'out') {
        outBtn.className = 'flex-1 py-3 px-4 rounded-lg font-semibold transition-all bg-indigo-600 text-white shadow-md';
        homeBtn.className = 'flex-1 py-3 px-4 rounded-lg font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      } else {
        homeBtn.className = 'flex-1 py-3 px-4 rounded-lg font-semibold transition-all bg-indigo-600 text-white shadow-md';
        outBtn.className = 'flex-1 py-3 px-4 rounded-lg font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      }
      fetchTrains();
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function findNearestStation(lat, lon) {
      let nearest = null, minDistance = Infinity;
      for (const s of GREAT_NORTHERN_STATIONS) {
        const d = calculateDistance(lat, lon, s.lat, s.lon);
        if (d < minDistance) { minDistance = d; nearest = s; }
      }
      return { station: nearest, distance: minDistance };
    }

    async function getUserLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) reject(new Error('Geolocation not supported'));
        navigator.geolocation.getCurrentPosition(
          pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
          err => reject(err),
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
        );
      });
    }

    async function fetchTrains() {
      const refreshIcon = document.getElementById('refreshIcon');
      const trainList = document.getElementById('trainList');
      const statusMessage = document.getElementById('statusMessage');
      const routeInfo = document.getElementById('routeInfo');
      refreshIcon.classList.add('animate-spin');
      statusMessage.classList.add('hidden');

      try {
        let fromStation, toStation;
        if (currentMode === 'out') {
          fromStation = PALMERS_GREEN.code;
          toStation = MOORGATE.code;
          routeInfo.textContent = `${PALMERS_GREEN.name} â†’ ${MOORGATE.name}`;
        } else {
          showStatus('info', 'Getting your location...');
          userLocation = await getUserLocation();
          const { station } = findNearestStation(userLocation.lat, userLocation.lon);
          fromStation = station.code;
          toStation = PALMERS_GREEN.code;
          routeInfo.textContent = `${station.name} â†’ ${PALMERS_GREEN.name}`;
        }

        let url;
        if (currentMode === 'home') {
          url = `https://huxley2.azurewebsites.net/departures/${fromStation}/20?expand=true`;
        } else {
          url = `https://huxley2.azurewebsites.net/departures/${fromStation}/to/${toStation}/20`;
        }

        const res = await fetch(url);
        if (!res.ok) throw new Error(`API error: ${res.status}`);
        const data = await res.json();

        if (data.trainServices && data.trainServices.length > 0) {
          displayTrains(data.trainServices.slice(0, 12));
          showStatus('success', 'Connected! Showing real-time trains');
        } else {
          trainList.innerHTML = '<div class="bg-white rounded-lg shadow-md p-8 text-center text-gray-500">No trains currently scheduled</div>';
          showStatus('warning', 'No trains found for this route');
        }
        document.getElementById('lastUpdate').textContent =
          'Last updated: ' + new Date().toLocaleTimeString('en-GB');
      } catch (err) {
        showStatus('error', 'Failed to fetch: ' + err.message);
      } finally {
        refreshIcon.classList.remove('animate-spin');
      }
    }

    function displayTrains(trains) {
      const trainList = document.getElementById('trainList');
      trainList.innerHTML = trains.map(train => {
        const scheduled = train.std || train.sta;
        const expected = train.etd || train.eta;
        const destination = train.destination?.[0]?.locationName || 'Unknown';
        const origin = train.origin?.[0]?.locationName || 'Unknown';
        const isCancelled = train.isCancelled;
        const isDelayed = expected && expected !== scheduled && expected !== 'On time' && !isCancelled;

        let status = 'On time', color = 'text-green-600', bg = 'bg-green-50', border = 'border-green-500';
        if (isCancelled) { status = 'Cancelled'; color = 'text-red-800'; bg = 'bg-red-100'; border = 'border-red-800'; }
        else if (isDelayed) { status = 'Delayed'; color = 'text-yellow-600'; bg = 'bg-yellow-50'; border = 'border-yellow-500'; }

        const journeyInfo =
          currentMode === 'home'
            ? `<div class="text-sm text-gray-700 mb-1"><span class="font-medium">Origin:</span> ${origin} â†’ <span class="font-medium">Destination:</span> ${destination}</div>`
            : `<div class="text-sm text-gray-700 mb-1"><span class="font-medium">Destination:</span> ${destination}</div>`;

        return `
          <div class="bg-white rounded-lg shadow-md p-4 ${bg} border-l-4 ${border}">
            <div class="flex justify-between mb-2">
              <div>
                <div class="text-2xl font-bold text-gray-800">${scheduled}</div>
                ${expected !== scheduled && !isCancelled ? `<div class="text-sm text-red-600 font-medium">Exp: ${expected}</div>` : ''}
              </div>
              <div class="font-semibold ${color}">${status}</div>
            </div>
            ${journeyInfo}
            <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
              <div><span class="font-medium">Platform:</span> ${train.platform || 'TBC'}</div>
              <div><span class="font-medium">Operator:</span> ${train.operator || 'Unknown'}</div>
            </div>
          </div>`;
      }).join('');
    }

    function showStatus(type, message) {
      const el = document.getElementById('statusMessage');
      const color = {
        success: 'bg-green-50 border-green-300 text-green-800',
        error: 'bg-red-50 border-red-300 text-red-800',
        warning: 'bg-yellow-50 border-yellow-300 text-yellow-800',
        info: 'bg-blue-50 border-blue-300 text-blue-800'
      }[type];
      el.className = `${color} border rounded-lg p-3 mb-4`;
      el.textContent = message;
      el.classList.remove('hidden');
    }

    function requestNotifications() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(p => {
          if (p === 'granted') {
            document.getElementById('notifyBtn').style.display = 'none';
            showStatus('success', 'Notifications enabled for delays.');
          }
        });
      }
    }

    document.getElementById('autoRefresh').addEventListener('change', e => {
      if (e.target.checked) autoRefreshInterval = setInterval(fetchTrains, 60000);
      else clearInterval(autoRefreshInterval);
    });

    if ('Notification' in window && Notification.permission === 'granted') {
      document.getElementById('notifyBtn').style.display = 'none';
    }

    fetchTrains();
    autoRefreshInterval = setInterval(fetchTrains, 60000);
  </script>
</body>
</html>
