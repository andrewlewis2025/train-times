<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Train Times">
    
    <!-- Cache Control - Prevent Caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- App Version - Update this with each deployment to force cache refresh -->
    <meta name="app-version" content="2.0.0">
    
    <title>Train Times - Palmers Green</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        @media (display-mode: standalone) {
            body { padding-top: env(safe-area-inset-top); }
        }
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(236, 72, 153, 0.3); }
            50% { box-shadow: 0 0 30px rgba(236, 72, 153, 0.5); }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes slide-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes train-move {
            0% { transform: translateX(-100px) rotate(0deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100px) rotate(0deg); opacity: 0; }
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        
        .animate-pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        .animate-gradient {
            background-size: 200% 200%;
            animation: gradient-shift 8s ease infinite;
        }
        
        .animate-slide-in {
            animation: slide-in 0.5s ease-out;
        }
        
        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            background-size: 1000px 100%;
            animation: shimmer 3s infinite;
        }
        
        .train-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .train-card:hover {
            transform: translateY(-4px) scale(1.02);
        }
        
        .bg-animated {
            background: linear-gradient(-45deg, #581c87, #4c1d95, #312e81, #1e1b4b);
            background-size: 400% 400%;
            animation: gradient-shift 15s ease infinite;
        }
        
        .glass-effect {
            background: rgba(30, 27, 75, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-card {
            background: rgba(20, 15, 45, 0.5);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
    </style>
</head>
<body class="min-h-screen bg-animated text-slate-100 relative overflow-x-hidden">
    <!-- Animated background elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div class="absolute top-20 left-10 w-72 h-72 bg-pink-500/10 rounded-full blur-3xl animate-float"></div>
        <div class="absolute bottom-20 right-10 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl animate-float" style="animation-delay: 1s;"></div>
        <div class="absolute top-1/2 left-1/2 w-80 h-80 bg-indigo-500/10 rounded-full blur-3xl animate-float" style="animation-delay: 2s;"></div>
    </div>
    <div class="max-w-4xl mx-auto p-4 sm:p-6 relative z-10">
        <!-- Prominent Header Card -->
        <div class="glass-effect rounded-3xl p-6 sm:p-8 mb-6 shadow-[0_20px_60px_rgba(0,0,0,0.5)] relative overflow-hidden">
            <div class="absolute inset-0 shimmer opacity-30"></div>
            <div class="relative z-10">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                    <div class="flex items-start gap-4">
                        <div class="flex items-center justify-center w-12 h-12 rounded-2xl bg-pink-500/20 border border-pink-500/40 animate-pulse-glow">
                            <svg class="w-6 h-6 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-purple-300 mb-1 tracking-wide">TRAIN TIMES</p>
                            <h1 class="text-3xl sm:text-4xl font-bold tracking-tight text-white mb-2">
                                Palmers Green
                            </h1>
                            <p class="text-sm text-purple-200/80">
                                Great Northern Â· Live departures
                            </p>
                        </div>
                    </div>
                    <button
                        onclick="fetchTrains()"
                        id="refreshBtn"
                        class="p-3 rounded-2xl border border-pink-500/30 bg-pink-500/10 hover:bg-pink-500/20 transition-all hover:scale-105 hover:border-pink-500/50 backdrop-blur-sm"
                        aria-label="Refresh trains"
                    >
                        <svg id="refreshIcon" class="w-6 h-6 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>

                <!-- Mode Toggle Buttons -->
                <div class="flex gap-2 mb-5 glass-card rounded-2xl p-1.5">
                    <button
                        onclick="setMode('out')"
                        id="outBtn"
                        class="flex-1 py-3 px-5 rounded-xl text-sm font-semibold transition-all bg-pink-500 text-white shadow-lg shadow-pink-500/40 hover:shadow-pink-500/60"
                    >
                        OUT
                    </button>
                    <button
                        onclick="setMode('home')"
                        id="homeBtn"
                        class="flex-1 py-3 px-5 rounded-xl text-sm font-semibold transition-all bg-transparent text-purple-200 hover:bg-white/5"
                    >
                        HOME
                    </button>
                </div>

                <!-- HOME mode station selector -->
                <div id="homeStationSelector" class="mb-4 hidden">
                    <label for="homeStationSelect" class="block text-xs font-semibold text-purple-300 mb-2 uppercase tracking-wide">
                        Departing from
                    </label>
                    <select
                        id="homeStationSelect"
                        class="w-full border border-purple-500/30 rounded-xl px-4 py-3 text-sm glass-card text-white focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500/50 transition-all"
                    >
                        <!-- Populated by JavaScript -->
                    </select>
                </div>
                
                <div class="text-sm mb-4 space-y-2">
                    <div id="routeInfo" class="font-bold text-lg text-white">
                        Palmers Green â†’ Moorgate
                    </div>
                    <div id="walkingTime" class="text-xs text-pink-300 font-medium hidden"></div>
                    <div class="flex items-center gap-2 text-xs text-purple-300/70">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span id="lastUpdate">Loading...</span>
                    </div>
                </div>

                <div class="flex items-center gap-4 flex-wrap pt-2 border-t border-purple-500/20">
                    <label class="flex items-center gap-2 cursor-pointer text-xs text-purple-200">
                        <input type="checkbox" id="autoRefresh" checked class="w-4 h-4 text-pink-500 rounded border-purple-500/30 bg-purple-900/30 focus:ring-pink-500 focus:ring-2">
                        <span>Auto refresh every minute</span>
                    </label>
                    
                    <button
                        onclick="requestNotifications()"
                        id="notifyBtn"
                        class="ml-auto text-xs text-pink-400 hover:text-pink-300 font-semibold flex items-center gap-2 transition-colors"
                    >
                        <span>ðŸ””</span>
                        <span>Enable alerts</span>
                    </button>
                    <button
                        onclick="clearCacheAndReload()"
                        class="text-xs text-purple-300 hover:text-purple-200 font-semibold flex items-center gap-2 transition-colors"
                        title="Clear cache and reload (useful if app looks outdated)"
                    >
                        <span>ðŸ”„</span>
                        <span>Force Update</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Message -->
        <div id="statusMessage" class="mb-5 hidden"></div>

        <!-- Train List -->
        <div id="trainList" class="space-y-4">
            <div class="glass-card rounded-3xl p-12 text-center text-purple-300/60 border-dashed border-2 border-purple-500/20">
                <div class="flex flex-col items-center gap-4">
                    <div class="relative">
                        <svg class="w-20 h-20 text-purple-500/40 animate-float" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <div class="absolute inset-0 bg-pink-500/20 rounded-full blur-xl animate-pulse-glow"></div>
                    </div>
                    <div>
                        <p class="text-sm font-semibold mb-1">Ready to load train times</p>
                        <p class="text-xs text-purple-400/60">Click the refresh button above to get started</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;
        let currentMode = 'out';
        let userLocation = null;

        let lastTrainServices = [];
        let trackedServiceID = null;
        let trackedServiceStatus = null;
        
        // Great Northern stations on the line to Palmers Green (southbound stations)
        const GREAT_NORTHERN_STATIONS = [
            { code: 'MOG', name: 'Moorgate', lat: 51.5188, lon: -0.0886 },
            { code: 'OLD', name: 'Old Street', lat: 51.5263, lon: -0.0877 },
            { code: 'EXR', name: 'Essex Road', lat: 51.5394, lon: -0.1042 },
            { code: 'HBY', name: 'Highbury & Islington', lat: 51.5461, lon: -0.1038 },
            { code: 'DRN', name: 'Drayton Park', lat: 51.5531, lon: -0.1117 },
            { code: 'FPK', name: 'Finsbury Park', lat: 51.5642, lon: -0.1065 },
            { code: 'HRY', name: 'Harringay', lat: 51.5818, lon: -0.1094 },
            { code: 'HPY', name: 'Hornsey', lat: 51.5875, lon: -0.1169 },
            { code: 'ALX', name: 'Alexandra Palace', lat: 51.5978, lon: -0.1197 },
            { code: 'BVP', name: 'Bowes Park', lat: 51.6021, lon: -0.1196 },
            { code: 'ARN', name: 'Arnos Grove', lat: 51.6163, lon: -0.1334 },
            { code: 'WGC', name: 'Winchmore Hill', lat: 51.6341, lon: -0.1008 },
            { code: 'GAN', name: 'Grange Park', lat: 51.6414, lon: -0.1044 },
            { code: 'ENF', name: 'Enfield Chase', lat: 51.6527, lon: -0.1047 },
            { code: 'GNT', name: 'Gordon Hill', lat: 51.6781, lon: -0.0852 },
            { code: 'CWN', name: 'Crews Hill', lat: 51.6945, lon: -0.0797 },
            { code: 'CHN', name: 'Cuffley', lat: 51.7086, lon: -0.1021 }
        ];

        const PALMERS_GREEN = { code: 'PAL', name: 'Palmers Green', lat: 51.6176, lon: -0.1116 };
        const MOORGATE = { code: 'MOG', name: 'Moorgate' };

        function setMode(mode) {
            currentMode = mode;
            const outBtn = document.getElementById('outBtn');
            const homeBtn = document.getElementById('homeBtn');
            const homeSelector = document.getElementById('homeStationSelector');

            if (mode === 'out') {
                outBtn.className = 'flex-1 py-3 px-5 rounded-xl text-sm font-semibold transition-all bg-pink-500 text-white shadow-lg shadow-pink-500/40 hover:shadow-pink-500/60';
                homeBtn.className = 'flex-1 py-3 px-5 rounded-xl text-sm font-semibold transition-all bg-transparent text-purple-200 hover:bg-white/5';
                homeSelector.classList.add('hidden');
                document.getElementById('routeInfo').textContent = `${PALMERS_GREEN.name} â†’ ${MOORGATE.name}`;
            } else {
                homeBtn.className = 'flex-1 py-3 px-5 rounded-xl text-sm font-semibold transition-all bg-pink-500 text-white shadow-lg shadow-pink-500/40 hover:shadow-pink-500/60';
                outBtn.className = 'flex-1 py-3 px-5 rounded-xl text-sm font-semibold transition-all bg-transparent text-purple-200 hover:bg-white/5';
                homeSelector.classList.remove('hidden');
            }
            
            fetchTrains();
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function getWalkingTime(fromLat, fromLon, toLat, toLon) {
            try {
                const distance = calculateDistance(fromLat, fromLon, toLat, toLon);
                const walkingMinutes = Math.round((distance * 1000) / 80);
                return walkingMinutes;
            } catch (error) {
                console.error('Error calculating walking time:', error);
                return null;
            }
        }

        async function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        });
                    },
                    (error) => {
                        reject(error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
                );
            });
        }

        function getServiceStatus(service) {
            if (!service) return null;

            if (service.isCancelled) return 'cancelled';

            const scheduled = service.std || service.sta;
            const expected = service.etd || service.eta;

            if (expected && expected !== scheduled && expected !== 'On time') {
                return 'delayed';
            }

            return 'onTime';
        }

        async function fetchTrains() {
            const refreshIcon = document.getElementById('refreshIcon');
            const trainList = document.getElementById('trainList');
            const statusMessage = document.getElementById('statusMessage');
            const routeInfo = document.getElementById('routeInfo');
            const walkingTimeEl = document.getElementById('walkingTime');
            
            refreshIcon.classList.add('animate-spin');
            statusMessage.classList.add('hidden');
            walkingTimeEl.classList.add('hidden');
            walkingTimeEl.innerHTML = '';

            try {
                let fromStation, toStation;
                let url;
                
                if (currentMode === 'out') {
                    fromStation = PALMERS_GREEN.code;
                    toStation = MOORGATE.code;
                    routeInfo.textContent = `${PALMERS_GREEN.name} â†’ ${MOORGATE.name}`;
                    url = `https://huxley2.azurewebsites.net/departures/${fromStation}/to/${toStation}/20`;
                } else {
                    const selectEl = document.getElementById('homeStationSelect');
                    const selectedCode = selectEl.value || GREAT_NORTHERN_STATIONS[0].code;
                    const station = GREAT_NORTHERN_STATIONS.find(s => s.code === selectedCode) || GREAT_NORTHERN_STATIONS[0];

                    fromStation = station.code;
                    routeInfo.textContent = `${station.name} â†’ ${PALMERS_GREEN.name}`;
                    url = `https://huxley2.azurewebsites.net/departures/${fromStation}/20?expand=true`;

                    const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${station.lat},${station.lon}&travelmode=walking`;

                    try {
                        userLocation = await getUserLocation();
                        const walkingMins = await getWalkingTime(
                            userLocation.lat, userLocation.lon,
                            station.lat, station.lon
                        );

                        if (walkingMins !== null) {
                            walkingTimeEl.innerHTML = `ðŸš¶ ${walkingMins} min walk to ${station.name} Â· <a href="${mapsUrl}" target="_blank" rel="noopener" class="underline text-pink-300 hover:text-pink-200 transition-colors">Open in Google Maps</a>`;
                        } else {
                            walkingTimeEl.innerHTML = `<a href="${mapsUrl}" target="_blank" rel="noopener" class="underline text-pink-300 hover:text-pink-200 transition-colors">Walking directions to ${station.name} in Google Maps</a>`;
                        }

                        walkingTimeEl.classList.remove('hidden');
                    } catch (locError) {
                        walkingTimeEl.innerHTML = `<a href="${mapsUrl}" target="_blank" rel="noopener" class="underline text-pink-300 hover:text-pink-200 transition-colors">Walking directions to ${station.name} in Google Maps</a>`;
                        walkingTimeEl.classList.remove('hidden');
                        console.warn('Could not get user location for walking time:', locError);
                    }
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                
                const data = await response.json();
                let services = data.trainServices || [];

                if (currentMode === 'home') {
                    services = services.filter(service => {
                        const groups = service.subsequentCallingPoints || [];
                        return groups.some(group =>
                            group.callingPoint &&
                            group.callingPoint.some(cp => cp.crs === PALMERS_GREEN.code)
                        );
                    });
                }

                lastTrainServices = services;

                if (trackedServiceID && services.length > 0 && 'Notification' in window && Notification.permission === 'granted') {
                    const trackedService = services.find(s => (s.serviceID || s.serviceId) === trackedServiceID);
                    if (trackedService) {
                        const newStatus = getServiceStatus(trackedService);
                        if (trackedServiceStatus && newStatus !== trackedServiceStatus) {
                            let body = '';
                            const scheduled = trackedService.std || trackedService.sta;
                            const expected = trackedService.etd || trackedService.eta;

                            if (newStatus === 'cancelled') {
                                body = `Your tracked train at ${scheduled} has been cancelled.`;
                            } else if (newStatus === 'delayed') {
                                body = `Your tracked train at ${scheduled} is now delayed (expected ${expected}).`;
                            } else if (newStatus === 'onTime') {
                                body = `Your tracked train at ${scheduled} is now showing on time.`;
                            }

                            if (body) {
                                new Notification('Train status update', {
                                    body,
                                    icon: 'ðŸš‚'
                                });
                            }
                        }
                        trackedServiceStatus = getServiceStatus(trackedService);
                    } else if (trackedServiceStatus) {
                        new Notification('Train status update', {
                            body: 'Your tracked train is no longer on the departures board. It may have departed.',
                            icon: 'ðŸš‚'
                        });
                        trackedServiceID = null;
                        trackedServiceStatus = null;
                    }
                }

                if (services.length > 0) {
                    displayTrains(services.slice(0, 12));
                    showStatus('success', 'Connected. Showing real time trains from National Rail.');
                } else {
                    trainList.innerHTML = '<div class="glass-card rounded-3xl p-12 text-center text-purple-300/60 border-dashed border-2 border-purple-500/20"><p class="text-sm font-medium">No trains currently scheduled</p></div>';
                    showStatus('warning', 'No trains found for this route.');
                }
                
                document.getElementById('lastUpdate').textContent = 
                    'Last updated: ' + new Date().toLocaleTimeString('en-GB');
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('error', `Failed to fetch train times: ${error.message}`);
                trainList.innerHTML = '<div class="glass-card rounded-3xl p-12 text-center text-red-300 border border-red-500/30"><p class="text-sm font-medium">Failed to load trains. Please try again.</p></div>';
            } finally {
                refreshIcon.classList.remove('animate-spin');
            }
        }

        function displayTrains(trains) {
            const trainList = document.getElementById('trainList');
            trainList.innerHTML = trains.map((train, index) => {
                const scheduled = train.std || train.sta;
                const expected = train.etd || train.eta;
                const isCancelled = train.isCancelled;
                const isDelayed = expected && expected !== scheduled && expected !== 'On time' && !isCancelled;
                const serviceId = train.serviceID || train.serviceId || '';
                const isTracked = serviceId && serviceId === trackedServiceID;

                let status = 'On time';
                let statusColor = 'text-pink-300';
                let borderColor = 'border-pink-500/50';
                let bgGradient = 'from-pink-500/10 to-purple-500/10';

                if (isCancelled) {
                    status = 'Cancelled';
                    statusColor = 'text-red-300';
                    borderColor = 'border-red-500/50';
                    bgGradient = 'from-red-500/10 to-rose-500/10';
                } else if (isDelayed) {
                    status = 'Delayed';
                    statusColor = 'text-amber-300';
                    borderColor = 'border-amber-500/50';
                    bgGradient = 'from-amber-500/10 to-yellow-500/10';
                }

                const trackedBadge = isTracked
                    ? '<span class="ml-2 inline-flex items-center px-2.5 py-1 rounded-full bg-pink-500/20 text-[10px] font-semibold text-pink-300 border border-pink-400/40">Tracking</span>'
                    : '';

                const extraRing = isTracked ? ' ring-2 ring-pink-400/50' : '';

                return `
                    <div
                        class="train-card glass-card rounded-2xl border-l-4 ${borderColor} cursor-pointer hover:bg-gradient-to-r ${bgGradient} px-5 py-4 hover:shadow-xl${extraRing} animate-slide-in"
                        style="animation-delay: ${index * 0.05}s;"
                        onclick="trackTrain('${serviceId.replace(/'/g, "\\'")}')"
                    >
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-4">
                                <div class="flex items-center justify-center w-12 h-12 rounded-xl bg-gradient-to-br ${bgGradient} border ${borderColor}">
                                    <svg class="w-6 h-6 text-white/80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <div class="text-3xl font-bold text-white leading-tight">${scheduled || 'TBC'}</div>
                                    ${expected && expected !== scheduled && !isCancelled ? 
                                        `<div class="text-xs text-amber-300 font-semibold mt-1">Exp ${expected}</div>` : ''}
                                </div>
                            </div>
                            <div class="text-right ${statusColor} text-xs font-bold tracking-wide uppercase">
                                ${status}${trackedBadge}
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-xs text-purple-200/70 mt-3 pt-3 border-t border-purple-500/20">
                            <div><span class="font-semibold text-purple-200">Platform</span> <span class="ml-2">${train.platform || 'TBC'}</span></div>
                            <div class="text-right"><span class="font-semibold text-purple-200">Operator</span> <span class="ml-2">${train.operator || 'Unknown'}</span></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function trackTrain(serviceId) {
            if (!serviceId) {
                showStatus('warning', 'Cannot track this service because it has no ID.');
                return;
            }

            if (trackedServiceID === serviceId) {
                trackedServiceID = null;
                trackedServiceStatus = null;
                showStatus('info', 'Stopped tracking this train.');
            } else {
                trackedServiceID = serviceId;
                trackedServiceStatus = null;
                showStatus('success', 'Now tracking this train for delays and cancellations.');
            }

            if (lastTrainServices && lastTrainServices.length > 0) {
                displayTrains(lastTrainServices.slice(0, 12));
            }
        }

        function showStatus(type, message) {
            const statusMessage = document.getElementById('statusMessage');
            const colors = {
                success: 'bg-pink-950/40 border-pink-700/50 text-pink-100',
                error: 'bg-red-950/40 border-red-700/50 text-red-100',
                warning: 'bg-amber-950/40 border-amber-700/50 text-amber-100',
                info: 'bg-purple-950/40 border-purple-700/50 text-purple-100'
            };
            
            statusMessage.className = `${colors[type]} border rounded-2xl px-4 py-3 mb-5 text-sm font-medium glass-effect backdrop-blur-sm`;
            statusMessage.innerHTML = `<div class="flex items-center gap-2"><span>${message}</span></div>`;
            statusMessage.classList.remove('hidden');
        }

        function requestNotifications() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        document.getElementById('notifyBtn').style.display = 'none';
                        showStatus('success', 'Notifications enabled. You will be alerted about your tracked train.');
                    }
                });
            }
        }

        function clearCacheAndReload() {
            // Clear version cache to force update check
            localStorage.removeItem(VERSION_KEY);
            localStorage.removeItem(LAST_CHECK_KEY);
            // Force reload with cache bypass
            window.location.href = window.location.href.split('?')[0] + '?v=' + Date.now() + '&_reload=1';
        }

        function populateHomeStations() {
            const selectEl = document.getElementById('homeStationSelect');
            if (!selectEl) return;

            selectEl.innerHTML = '';
            GREAT_NORTHERN_STATIONS.forEach(station => {
                const opt = document.createElement('option');
                opt.value = station.code;
                opt.textContent = station.name;
                if (station.code === 'FPK') {
                    opt.selected = true;
                }
                selectEl.appendChild(opt);
            });
        }

        document.getElementById('autoRefresh').addEventListener('change', (e) => {
            if (e.target.checked) {
                autoRefreshInterval = setInterval(fetchTrains, 60000);
            } else {
                clearInterval(autoRefreshInterval);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            populateHomeStations();
            const homeSelect = document.getElementById('homeStationSelect');
            if (homeSelect) {
                homeSelect.addEventListener('change', () => {
                    if (currentMode === 'home') {
                        fetchTrains();
                    }
                });
            }
        });

        if ('Notification' in window && Notification.permission === 'granted') {
            document.getElementById('notifyBtn').style.display = 'none';
        }

        // App Version Management - Force updates on iOS home screen
        // IMPORTANT: Update APP_VERSION in both the meta tag and here when deploying new changes
        const APP_VERSION = '2.0.0';
        const VERSION_KEY = 'train-times-version';
        const LAST_CHECK_KEY = 'train-times-last-check';

        function checkForUpdates() {
            // Check if we're in standalone mode (iOS home screen app)
            const isStandalone = window.navigator.standalone || 
                                 window.matchMedia('(display-mode: standalone)').matches;
            
            if (!isStandalone) {
                // For regular browser, check every 5 minutes
                const lastCheck = localStorage.getItem(LAST_CHECK_KEY);
                const now = Date.now();
                if (lastCheck && (now - parseInt(lastCheck)) < 300000) {
                    return; // Checked recently, skip
                }
            }

            // Fetch the current page with cache-busting to check version
            const url = `${window.location.origin}${window.location.pathname}?v=${Date.now()}&_nocache=1`;
            fetch(url, {
                method: 'GET',
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.text();
            })
            .then(html => {
                // Extract version from meta tag
                const versionMatch = html.match(/<meta\s+name=["']app-version["']\s+content=["']([^"']+)["']>/i);
                if (versionMatch && versionMatch[1]) {
                    const serverVersion = versionMatch[1];
                    const localVersion = localStorage.getItem(VERSION_KEY);
                    
                    if (localVersion && localVersion !== serverVersion) {
                        // New version detected - force reload
                        console.log(`Update detected: ${localVersion} -> ${serverVersion}`);
                        localStorage.setItem(VERSION_KEY, serverVersion);
                        
                        // Auto-reload in standalone mode, ask in browser
                        if (isStandalone) {
                            // In standalone mode, reload immediately
                            window.location.reload(true);
                        } else {
                            // In browser, ask user
                            if (confirm('A new version is available! Reload now?')) {
                                window.location.reload(true);
                            } else {
                                localStorage.setItem(VERSION_KEY, serverVersion);
                            }
                        }
                    } else if (!localVersion) {
                        // First time - store current version
                        localStorage.setItem(VERSION_KEY, APP_VERSION);
                    }
                }
                
                localStorage.setItem(LAST_CHECK_KEY, Date.now().toString());
            })
            .catch(error => {
                console.warn('Update check failed:', error);
                // Don't spam checks if network is down
                localStorage.setItem(LAST_CHECK_KEY, Date.now().toString());
            });
        }

        // Store current version
        if (!localStorage.getItem(VERSION_KEY)) {
            localStorage.setItem(VERSION_KEY, APP_VERSION);
        }

        // Check for updates on load
        checkForUpdates();

        // Check for updates periodically (every 2 minutes in standalone mode, 5 minutes otherwise)
        const isStandalone = window.navigator.standalone || 
                             window.matchMedia('(display-mode: standalone)').matches;
        const updateCheckInterval = isStandalone ? 120000 : 300000;
        setInterval(checkForUpdates, updateCheckInterval);

        // Also check when app comes to foreground (iOS specific)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                checkForUpdates();
            }
        });

        // Force reload on focus if in standalone mode (iOS)
        if (isStandalone) {
            window.addEventListener('focus', () => {
                checkForUpdates();
            });
        }

        fetchTrains();
        autoRefreshInterval = setInterval(fetchTrains, 60000);
    </script>
</body>
</html>