<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nearest Great Northern Station → Palmers Green</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
  <h1 class="text-2xl font-bold mb-4 text-center">Nearest Great Northern → Palmers Green</h1>
  <div id="status" class="text-center text-gray-700 mb-4">Finding your location...</div>
  <div id="results" class="max-w-2xl mx-auto bg-white shadow-md rounded-xl p-4"></div>

  <script>
    const APP_ID = "e93db4ec";
    const APP_KEY = "b85454249e10c63caf55d55de9bd7d73";

    async function getNearestStation(lat, lon) {
      const url = `https://transportapi.com/v3/uk/places.json?lat=${lat}&lon=${lon}&type=train_station&app_id=${APP_ID}&app_key=${APP_KEY}`;
      const res = await fetch(url);
      const data = await res.json();
      const stations = data.member.filter(s => s.name.includes("Great Northern") || s.network === "Great Northern");
      return stations.length ? stations[0] : data.member[0];
    }

    async function getTrainTimes(stationCode) {
      const url = `https://transportapi.com/v3/uk/train/station/${stationCode}/live.json?app_id=${APP_ID}&app_key=${APP_KEY}&darwin=true&train_status=passenger`;
      const res = await fetch(url);
      return res.json();
    }

    function getGoogleMapsLink(from, to) {
      return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from)}&destination=${encodeURIComponent(to)}&travelmode=walking`;
    }

    function displayTrains(data, station, lat, lon) {
      const container = document.getElementById("results");
      const departures = data.departures.all.filter(t => t.destination_name.includes("Palmers Green"));
      const mapsLink = getGoogleMapsLink(`${lat},${lon}`, station.name);
      let html = `
        <h2 class="text-xl font-semibold mb-2">${station.name}</h2>
        <p class="text-sm mb-3">(${station.station_code}) - <a class="text-blue-600 underline" href="${mapsLink}" target="_blank">Walking directions</a></p>
      `;
      if (departures.length === 0) {
        html += `<p>No upcoming trains towards Palmers Green found.</p>`;
      } else {
        html += `<ul class="divide-y divide-gray-200">`;
        departures.slice(0, 5).forEach(train => {
          html += `
            <li class="py-2">
              <div><strong>${train.destination_name}</strong></div>
              <div>Departs: ${train.aimed_departure_time} → Expected: ${train.expected_departure_time}</div>
              <div>Platform: ${train.platform || "—"}</div>
            </li>
          `;
        });
        html += `</ul>`;
      }
      container.innerHTML = html;
    }

    function showError(message) {
      document.getElementById("status").textContent = message;
    }

    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const { latitude, longitude } = pos.coords;
        document.getElementById("status").textContent = "Finding nearest station...";
        const station = await getNearestStation(latitude, longitude);
        document.getElementById("status").textContent = `Fetching trains from ${station.name}...`;
        const data = await getTrainTimes(station.station_code);
        document.getElementById("status").textContent = "";
        displayTrains(data, station, latitude, longitude);
      }, () => showError("Could not access location."));
    } else {
      showError("Geolocation not supported by your browser.");
    }
  </script>
</body>
</html>
