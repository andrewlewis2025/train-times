<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Train Times â€“ Palmers Green</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="max-w-2xl mx-auto p-4">
    <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold text-gray-800">Train Times</h1>
        <button onclick="fetchTrains()" id="refreshBtn"
          class="p-2 rounded-full hover:bg-gray-100 transition-colors">
          ðŸ”„
        </button>
      </div>
      <div class="flex gap-2 mb-4">
        <button onclick="setMode('out')" id="outBtn"
          class="flex-1 py-3 px-4 rounded-lg font-semibold bg-indigo-600 text-white">
          OUT
        </button>
        <button onclick="setMode('home')" id="homeBtn"
          class="flex-1 py-3 px-4 rounded-lg font-semibold bg-gray-200 text-gray-700">
          HOME
        </button>
      </div>
      <div id="statusMessage" class="hidden mb-4"></div>
      <div id="routeInfo" class="text-sm text-gray-600 mb-3"></div>
      <div id="walkingTime" class="text-xs text-indigo-600 font-medium mt-1 hidden"></div>
    </div>
    <div id="trainList" class="space-y-3"></div>
  </div>

  <script>
    const PALMERS_GREEN = { code: 'PAL', name: 'Palmers Green', lat: 51.6176, lon: -0.1116 };
    const MOORGATE = { code: 'MOG', name: 'Moorgate' };
    let currentMode = 'out';
    const proxy = "https://corsproxy.io/?";

    function setMode(mode) {
      currentMode = mode;
      document.getElementById('outBtn').classList.toggle('bg-indigo-600', mode === 'out');
      document.getElementById('homeBtn').classList.toggle('bg-indigo-600', mode === 'home');
      fetchTrains();
    }

    async function getUserLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) reject(new Error('Geolocation not supported'));
        navigator.geolocation.getCurrentPosition(
          pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
          err => reject(err),
          { enableHighAccuracy: true, timeout: 15000 }
        );
      });
    }

    function showStatus(type, msg) {
      const el = document.getElementById('statusMessage');
      const colors = {
        success: 'bg-green-50 text-green-800 border border-green-200',
        error: 'bg-red-50 text-red-800 border border-red-200',
        warning: 'bg-yellow-50 text-yellow-800 border border-yellow-200',
        info: 'bg-blue-50 text-blue-800 border border-blue-200'
      };
      el.className = `${colors[type]} p-3 rounded mb-4`;
      el.innerText = msg;
      el.classList.remove('hidden');
    }

    async function fetchTrains() {
      const trainList = document.getElementById('trainList');
      trainList.innerHTML = 'Loading...';
      showStatus('info', 'Fetching live data...');

      try {
        let from = PALMERS_GREEN.code;
        let to = MOORGATE.code;
        let url;

        if (currentMode === 'home') {
          showStatus('info', 'Getting your location...');
          let loc;
          try { loc = await getUserLocation(); }
          catch { showStatus('error', 'Location unavailable. Using Moorgate as default.'); }

          const nearest = PALMERS_GREEN; // simplify for now
          from = nearest.code;
          to = PALMERS_GREEN.code;
          url = `${proxy}https://huxley2.azurewebsites.net/departures/${from}/20`;
        } else {
          url = `${proxy}https://huxley2.azurewebsites.net/departures/${from}/to/${to}/20`;
        }

        const res = await fetch(url, { timeout: 20000 });
        if (!res.ok) throw new Error('API unreachable');
        const data = await res.json();

        const trains = data.trainServices?.filter(t => {
          if (currentMode === 'out') return true;
          const d = (t.destination?.[0]?.locationName || '').toLowerCase();
          if (d.includes('palmers green')) return true;
          return t.subsequentCallingPoints?.some(cpList =>
            cpList.callingPoint?.some(cp =>
              cp.locationName?.toLowerCase().includes('palmers green')
            )
          );
        }) || [];

        if (trains.length === 0) {
          trainList.innerHTML = '<div class="p-4 bg-white text-gray-500 rounded">No trains found</div>';
          showStatus('warning', 'No trains stopping at Palmers Green found.');
          return;
        }

        trainList.innerHTML = trains.slice(0, 10).map(t => `
          <div class="bg-white rounded shadow p-4 border-l-4 border-green-500">
            <div class="flex justify-between">
              <div>
                <div class="text-2xl font-bold">${t.std || t.sta}</div>
                <div class="text-sm text-gray-600">to ${t.destination?.[0]?.locationName || ''}</div>
              </div>
              <div class="text-green-600 font-semibold">${t.etd || 'On time'}</div>
            </div>
          </div>
        `).join('');
        showStatus('success', 'Live data loaded.');
      } catch (e) {
        showStatus('error', `Failed: ${e.message}`);
        trainList.innerHTML = '<div class="bg-white text-center text-red-500 p-4 rounded">Error loading trains</div>';
      }
    }

    fetchTrains();
  </script>
</body>
</html>
