<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Train Times">
    <title>Train Times - Palmers Green</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media (display-mode: standalone) {
            body { padding-top: env(safe-area-inset-top); }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-100">
    <div class="max-w-2xl mx-auto p-4">
        <!-- Header with Mode Toggle -->
        <div class="bg-slate-900/80 border border-slate-700 rounded-2xl backdrop-blur p-6 mb-4 shadow-[0_18px_60px_rgba(0,0,0,0.45)]">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center w-9 h-9 rounded-xl bg-emerald-500/10 border border-emerald-500/40">
                        <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-semibold tracking-tight text-slate-50">
                            Palmers Green Train Times
                        </h1>
                        <p class="text-xs text-slate-400">
                            Great Northern Â· Live departures
                        </p>
                    </div>
                </div>
                <button
                    onclick="fetchTrains()"
                    id="refreshBtn"
                    class="p-2 rounded-full border border-slate-700 bg-slate-900/60 hover:bg-slate-800 transition-colors"
                    aria-label="Refresh trains"
                >
                    <svg id="refreshIcon" class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>

            <!-- Mode Toggle Buttons -->
            <div class="flex gap-2 mb-4 bg-slate-900/80 border border-slate-800 rounded-xl p-1">
                <button
                    onclick="setMode('out')"
                    id="outBtn"
                    class="flex-1 py-2.5 px-4 rounded-lg text-sm font-medium transition-all bg-emerald-500 text-slate-950 shadow-sm shadow-emerald-500/40"
                >
                    OUT
                </button>
                <button
                    onclick="setMode('home')"
                    id="homeBtn"
                    class="flex-1 py-2.5 px-4 rounded-lg text-sm font-medium transition-all bg-transparent text-slate-300 hover:bg-slate-800/80"
                >
                    HOME
                </button>
            </div>

            <!-- HOME mode station selector -->
            <div id="homeStationSelector" class="mb-3 hidden">
                <label for="homeStationSelect" class="block text-xs font-medium text-slate-400 mb-1">
                    Departing from
                </label>
                <select
                    id="homeStationSelect"
                    class="w-full border border-slate-700 rounded-lg px-3 py-2 text-sm bg-slate-900/80 text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                >
                    <!-- Populated by JavaScript -->
                </select>
            </div>
            
            <div class="text-xs text-slate-400 mb-3 space-y-1.5">
                <div id="routeInfo" class="font-medium text-slate-100">
                    Palmers Green â†’ Moorgate
                </div>
                <div id="walkingTime" class="text-[11px] text-emerald-300 font-medium mt-0.5 hidden"></div>
                <div class="flex items-center gap-2 mt-0.5 text-[11px]">
                    <svg class="w-3.5 h-3.5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span id="lastUpdate">Loading...</span>
                </div>
            </div>

            <div class="flex items-center gap-3 flex-wrap">
                <label class="flex items-center gap-2 cursor-pointer text-xs text-slate-300">
                    <input type="checkbox" id="autoRefresh" checked class="w-4 h-4 text-emerald-500 rounded border-slate-600 bg-slate-900">
                    <span>Auto refresh every minute</span>
                </label>
                
                <button
                    onclick="requestNotifications()"
                    id="notifyBtn"
                    class="ml-auto text-xs text-emerald-300 hover:text-emerald-200 font-medium flex items-center gap-1"
                >
                    <span>ðŸ””</span>
                    <span>Enable alerts</span>
                </button>
            </div>
        </div>

        <!-- Status Message -->
        <div id="statusMessage" class="mb-4 hidden"></div>

        <!-- Train List -->
        <div id="trainList" class="space-y-3">
            <div class="bg-slate-900/70 border border-slate-800 rounded-2xl p-8 text-center text-slate-400">
                Click refresh to load train times
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;
        let currentMode = 'out';
        let userLocation = null;

        let lastTrainServices = [];
        let trackedServiceID = null;
        let trackedServiceStatus = null;
        
        // Great Northern stations on the line to Palmers Green (southbound stations)
        const GREAT_NORTHERN_STATIONS = [
            { code: 'MOG', name: 'Moorgate', lat: 51.5188, lon: -0.0886 },
            { code: 'OLD', name: 'Old Street', lat: 51.5263, lon: -0.0877 },
            { code: 'EXR', name: 'Essex Road', lat: 51.5394, lon: -0.1042 },
            { code: 'HBY', name: 'Highbury & Islington', lat: 51.5461, lon: -0.1038 },
            { code: 'DRN', name: 'Drayton Park', lat: 51.5531, lon: -0.1117 },
            { code: 'FPK', name: 'Finsbury Park', lat: 51.5642, lon: -0.1065 },
            { code: 'HRY', name: 'Harringay', lat: 51.5818, lon: -0.1094 },
            { code: 'HPY', name: 'Hornsey', lat: 51.5875, lon: -0.1169 },
            { code: 'ALX', name: 'Alexandra Palace', lat: 51.5978, lon: -0.1197 },
            { code: 'BVP', name: 'Bowes Park', lat: 51.6021, lon: -0.1196 },
            { code: 'ARN', name: 'Arnos Grove', lat: 51.6163, lon: -0.1334 },
            { code: 'WGC', name: 'Winchmore Hill', lat: 51.6341, lon: -0.1008 },
            { code: 'GAN', name: 'Grange Park', lat: 51.6414, lon: -0.1044 },
            { code: 'ENF', name: 'Enfield Chase', lat: 51.6527, lon: -0.1047 },
            { code: 'GNT', name: 'Gordon Hill', lat: 51.6781, lon: -0.0852 },
            { code: 'CWN', name: 'Crews Hill', lat: 51.6945, lon: -0.0797 },
            { code: 'CHN', name: 'Cuffley', lat: 51.7086, lon: -0.1021 }
        ];

        const PALMERS_GREEN = { code: 'PAL', name: 'Palmers Green', lat: 51.6176, lon: -0.1116 };
        const MOORGATE = { code: 'MOG', name: 'Moorgate' };

        function setMode(mode) {
            currentMode = mode;
            const outBtn = document.getElementById('outBtn');
            const homeBtn = document.getElementById('homeBtn');
            const homeSelector = document.getElementById('homeStationSelector');

            if (mode === 'out') {
                outBtn.className = 'flex-1 py-2.5 px-4 rounded-lg text-sm font-medium transition-all bg-emerald-500 text-slate-950 shadow-sm shadow-emerald-500/40';
                homeBtn.className = 'flex-1 py-2.5 px-4 rounded-lg text-sm font-medium transition-all bg-transparent text-slate-300 hover:bg-slate-800/80';
                homeSelector.classList.add('hidden');
                document.getElementById('routeInfo').textContent = `${PALMERS_GREEN.name} â†’ ${MOORGATE.name}`;
            } else {
                homeBtn.className = 'flex-1 py-2.5 px-4 rounded-lg text-sm font-medium transition-all bg-emerald-500 text-slate-950 shadow-sm shadow-emerald-500/40';
                outBtn.className = 'flex-1 py-2.5 px-4 rounded-lg text-sm font-medium transition-all bg-transparent text-slate-300 hover:bg-slate-800/80';
                homeSelector.classList.remove('hidden');
            }
            
            fetchTrains();
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function getWalkingTime(fromLat, fromLon, toLat, toLon) {
            try {
                const distance = calculateDistance(fromLat, fromLon, toLat, toLon);
                const walkingMinutes = Math.round((distance * 1000) / 80);
                return walkingMinutes;
            } catch (error) {
                console.error('Error calculating walking time:', error);
                return null;
            }
        }

        async function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        });
                    },
                    (error) => {
                        reject(error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
                );
            });
        }

        function getServiceStatus(service) {
            if (!service) return null;

            if (service.isCancelled) return 'cancelled';

            const scheduled = service.std || service.sta;
            const expected = service.etd || service.eta;

            if (expected && expected !== scheduled && expected !== 'On time') {
                return 'delayed';
            }

            return 'onTime';
        }

        async function fetchTrains() {
            const refreshIcon = document.getElementById('refreshIcon');
            const trainList = document.getElementById('trainList');
            const statusMessage = document.getElementById('statusMessage');
            const routeInfo = document.getElementById('routeInfo');
            const walkingTimeEl = document.getElementById('walkingTime');
            
            refreshIcon.classList.add('animate-spin');
            statusMessage.classList.add('hidden');
            walkingTimeEl.classList.add('hidden');
            walkingTimeEl.innerHTML = '';

            try {
                let fromStation, toStation;
                let url;
                
                if (currentMode === 'out') {
                    fromStation = PALMERS_GREEN.code;
                    toStation = MOORGATE.code;
                    routeInfo.textContent = `${PALMERS_GREEN.name} â†’ ${MOORGATE.name}`;
                    url = `https://huxley2.azurewebsites.net/departures/${fromStation}/to/${toStation}/20`;
                } else {
                    const selectEl = document.getElementById('homeStationSelect');
                    const selectedCode = selectEl.value || GREAT_NORTHERN_STATIONS[0].code;
                    const station = GREAT_NORTHERN_STATIONS.find(s => s.code === selectedCode) || GREAT_NORTHERN_STATIONS[0];

                    fromStation = station.code;
                    routeInfo.textContent = `${station.name} â†’ ${PALMERS_GREEN.name}`;
                    url = `https://huxley2.azurewebsites.net/departures/${fromStation}/20?expand=true`;

                    const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${station.lat},${station.lon}&travelmode=walking`;

                    try {
                        userLocation = await getUserLocation();
                        const walkingMins = await getWalkingTime(
                            userLocation.lat, userLocation.lon,
                            station.lat, station.lon
                        );

                        if (walkingMins !== null) {
                            walkingTimeEl.innerHTML = `ðŸš¶ ${walkingMins} min walk to ${station.name} Â· <a href="${mapsUrl}" target="_blank" rel="noopener" class="underline text-emerald-300">Open in Google Maps</a>`;
                        } else {
                            walkingTimeEl.innerHTML = `<a href="${mapsUrl}" target="_blank" rel="noopener" class="underline text-emerald-300">Walking directions to ${station.name} in Google Maps</a>`;
                        }

                        walkingTimeEl.classList.remove('hidden');
                    } catch (locError) {
                        walkingTimeEl.innerHTML = `<a href="${mapsUrl}" target="_blank" rel="noopener" class="underline text-emerald-300">Walking directions to ${station.name} in Google Maps</a>`;
                        walkingTimeEl.classList.remove('hidden');
                        console.warn('Could not get user location for walking time:', locError);
                    }
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                
                const data = await response.json();
                let services = data.trainServices || [];

                if (currentMode === 'home') {
                    services = services.filter(service => {
                        const groups = service.subsequentCallingPoints || [];
                        return groups.some(group =>
                            group.callingPoint &&
                            group.callingPoint.some(cp => cp.crs === PALMERS_GREEN.code)
                        );
                    });
                }

                lastTrainServices = services;

                if (trackedServiceID && services.length > 0 && 'Notification' in window && Notification.permission === 'granted') {
                    const trackedService = services.find(s => (s.serviceID || s.serviceId) === trackedServiceID);
                    if (trackedService) {
                        const newStatus = getServiceStatus(trackedService);
                        if (trackedServiceStatus && newStatus !== trackedServiceStatus) {
                            let body = '';
                            const scheduled = trackedService.std || trackedService.sta;
                            const expected = trackedService.etd || trackedService.eta;

                            if (newStatus === 'cancelled') {
                                body = `Your tracked train at ${scheduled} has been cancelled.`;
                            } else if (newStatus === 'delayed') {
                                body = `Your tracked train at ${scheduled} is now delayed (expected ${expected}).`;
                            } else if (newStatus === 'onTime') {
                                body = `Your tracked train at ${scheduled} is now showing on time.`;
                            }

                            if (body) {
                                new Notification('Train status update', {
                                    body,
                                    icon: 'ðŸš‚'
                                });
                            }
                        }
                        trackedServiceStatus = getServiceStatus(trackedService);
                    } else if (trackedServiceStatus) {
                        new Notification('Train status update', {
                            body: 'Your tracked train is no longer on the departures board. It may have departed.',
                            icon: 'ðŸš‚'
                        });
                        trackedServiceID = null;
                        trackedServiceStatus = null;
                    }
                }

                if (services.length > 0) {
                    displayTrains(services.slice(0, 12));
                    showStatus('success', 'Connected. Showing real time trains from National Rail.');
                } else {
                    trainList.innerHTML = '<div class="bg-slate-900/70 border border-slate-800 rounded-2xl p-8 text-center text-slate-400">No trains currently scheduled</div>';
                    showStatus('warning', 'No trains found for this route.');
                }
                
                document.getElementById('lastUpdate').textContent = 
                    'Last updated: ' + new Date().toLocaleTimeString('en-GB');
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('error', `Failed to fetch train times: ${error.message}`);
                trainList.innerHTML = '<div class="bg-slate-900/70 border border-rose-800/60 rounded-2xl p-8 text-center text-rose-300">Failed to load trains. Please try again.</div>';
            } finally {
                refreshIcon.classList.remove('animate-spin');
            }
        }

        function displayTrains(trains) {
            const trainList = document.getElementById('trainList');
            trainList.innerHTML = trains.map(train => {
                const scheduled = train.std || train.sta;
                const expected = train.etd || train.eta;
                const isCancelled = train.isCancelled;
                const isDelayed = expected && expected !== scheduled && expected !== 'On time' && !isCancelled;
                const serviceId = train.serviceID || train.serviceId || '';
                const isTracked = serviceId && serviceId === trackedServiceID;

                let status = 'On time';
                let statusColor = 'text-emerald-300';
                let statusBg = 'bg-slate-900/80';
                let borderColor = 'border-emerald-500';

                if (isCancelled) {
                    status = 'Cancelled';
                    statusColor = 'text-rose-300';
                    statusBg = 'bg-rose-900/20';
                    borderColor = 'border-rose-500';
                } else if (isDelayed) {
                    status = 'Delayed';
                    statusColor = 'text-amber-300';
                    statusBg = 'bg-amber-900/20';
                    borderColor = 'border-amber-400';
                }

                const trackedBadge = isTracked
                    ? '<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full bg-emerald-500/15 text-[10px] font-medium text-emerald-300 border border-emerald-400/40">Tracking</span>'
                    : '';

                const extraRing = isTracked ? ' ring-1 ring-emerald-400/70' : '';

                return `
                    <div
                        class="bg-slate-900/80 rounded-2xl border-l-4 ${borderColor} border border-slate-800 cursor-pointer hover:bg-slate-800/90 transition-colors px-4 py-3${extraRing}"
                        onclick="trackTrain('${serviceId.replace(/'/g, "\\'")}')"
                    >
                        <div class="flex items-center justify-between mb-1.5">
                            <div class="flex items-center gap-3">
                                <div>
                                    <div class="text-2xl font-semibold text-slate-50 leading-tight">${scheduled || 'TBC'}</div>
                                    ${expected && expected !== scheduled && !isCancelled ? 
                                        `<div class="text-xs text-amber-300 font-medium mt-0.5">Exp ${expected}</div>` : ''}
                                </div>
                            </div>
                            <div class="text-right ${statusColor} text-xs font-semibold tracking-wide uppercase">
                                ${status}${trackedBadge}
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-[11px] text-slate-300 mt-2">
                            <div><span class="font-medium text-slate-200">Platform</span> <span class="text-slate-400 ml-1.5">${train.platform || 'TBC'}</span></div>
                            <div class="text-right"><span class="font-medium text-slate-200">Operator</span> <span class="text-slate-400 ml-1.5">${train.operator || 'Unknown'}</span></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function trackTrain(serviceId) {
            if (!serviceId) {
                showStatus('warning', 'Cannot track this service because it has no ID.');
                return;
            }

            if (trackedServiceID === serviceId) {
                trackedServiceID = null;
                trackedServiceStatus = null;
                showStatus('info', 'Stopped tracking this train.');
            } else {
                trackedServiceID = serviceId;
                trackedServiceStatus = null;
                showStatus('success', 'Now tracking this train for delays and cancellations.');
            }

            if (lastTrainServices && lastTrainServices.length > 0) {
                displayTrains(lastTrainServices.slice(0, 12));
            }
        }

        function showStatus(type, message) {
            const statusMessage = document.getElementById('statusMessage');
            const colors = {
                success: 'bg-emerald-950/60 border-emerald-700/80 text-emerald-100',
                error: 'bg-rose-950/60 border-rose-700/80 text-rose-100',
                warning: 'bg-amber-950/60 border-amber-700/80 text-amber-100',
                info: 'bg-slate-900/70 border-slate-600 text-slate-100'
            };
            
            statusMessage.className = `${colors[type]} border rounded-xl px-3.5 py-2.5 mb-4 text-xs`;
            statusMessage.innerHTML = `<div>${message}</div>`;
            statusMessage.classList.remove('hidden');
        }

        function requestNotifications() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        document.getElementById('notifyBtn').style.display = 'none';
                        showStatus('success', 'Notifications enabled. You will be alerted about your tracked train.');
                    }
                });
            }
        }

        function populateHomeStations() {
            const selectEl = document.getElementById('homeStationSelect');
            if (!selectEl) return;

            selectEl.innerHTML = '';
            GREAT_NORTHERN_STATIONS.forEach(station => {
                const opt = document.createElement('option');
                opt.value = station.code;
                opt.textContent = station.name;
                if (station.code === 'FPK') {
                    opt.selected = true;
                }
                selectEl.appendChild(opt);
            });
        }

        document.getElementById('autoRefresh').addEventListener('change', (e) => {
            if (e.target.checked) {
                autoRefreshInterval = setInterval(fetchTrains, 60000);
            } else {
                clearInterval(autoRefreshInterval);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            populateHomeStations();
            const homeSelect = document.getElementById('homeStationSelect');
            if (homeSelect) {
                homeSelect.addEventListener('change', () => {
                    if (currentMode === 'home') {
                        fetchTrains();
                    }
                });
            }
        });

        if ('Notification' in window && Notification.permission === 'granted') {
            document.getElementById('notifyBtn').style.display = 'none';
        }

        fetchTrains();
        autoRefreshInterval = setInterval(fetchTrains, 60000);
    </script>
</body>
</html>