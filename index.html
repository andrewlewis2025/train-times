<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF‑8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Train Times – Palmers Green</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="max-w-2xl mx-auto p-4">
    <!-- Header with mode toggle -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor"
               stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M3 10h1l2 9h12l2-9h1"></path>
          </svg>
          <h1 class="text-2xl font-bold text-gray-800">Train Times</h1>
        </div>
        <button onclick="refreshHome()" id="refreshBtn"
                class="flex items-center gap-1 text-indigo-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2"
               viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M4 4v6h6M20 20v-6h-6M9 14l-5 5m0 0l5 5m-5-5h14m-7-7l5-5m0 0l-5-5m5 5H5"></path>
          </svg>
          Home
        </button>
      </div>
      <p id="status" class="text-gray-500 mb-2"></p>
      <div id="results" class="space-y-4"></div>
    </div>
  </div>

<script>
/*
 * Configuration: list of nearby Great Northern stations with codes and coords.
 * To add or remove stations, update this array.  Coordinates are approximate.
 */
const stations = [
  {name: 'Winchmore Hill', code: 'WMH', lat: 51.6332, lon: -0.0980},
  {name: 'Grange Park',    code: 'GPK', lat: 51.6342, lon: -0.1023},
  {name: 'Palmers Green',  code: 'PAL', lat: 51.6183, lon: -0.1104},
  {name: 'Bowes Park',     code: 'BOP', lat: 51.6075, lon: -0.1221},
  {name: 'Alexandra Palace', code: 'AAP', lat: 51.5980, lon: -0.1209}
];

/*
 * Compute haversine distance in kilometres between two lat/lon points.
 */
function haversine(lat1, lon1, lat2, lon2) {
  const toRad = deg => deg * Math.PI / 180;
  const R = 6371; // Earth radius in km
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/*
 * Find the nearest station to the user’s coordinates.
 * Optionally skip Palmers Green itself for departure purposes.
 */
function findNearestStation(userLat, userLon) {
  let best = null;
  for (const st of stations) {
    if (st.code === 'PAL') continue; // skip Palmers Green as origin
    const distance = haversine(userLat, userLon, st.lat, st.lon);
    if (!best || distance < best.distance) {
      best = {station: st, distance};
    }
  }
  return best.station;
}

/*
 * Fetch live departures from Huxley2 (or similar) and find services calling at Palmers Green.
 * You must supply your own accessToken obtained from National Rail Enquiries.  The API
 * returns departures for a station code; then for each service we request details to
 * see if Palmers Green appears in the calling points.
 */
async function fetchTrainsForStation(stationCode) {
  const token = '<YOUR_ACCESS_TOKEN_HERE>';  // replace with your token
  const departuresUrl = `https://huxley2.azurewebsites.net/all/${stationCode}/50?accessToken=${token}&expand=true`;
  const resp = await fetch(departuresUrl);
  if (!resp.ok) throw new Error('Failed to fetch departures');
  const data = await resp.json();
  const filteredServices = [];
  // iterate through each service to see if Palmers Green appears
  for (const service of data.trainServices || []) {
    const callingPoints = (service.subsequentCallingPoints?.[0]?.callingPoint || [])
      .map(pt => pt.locationName.toLowerCase());
    if (callingPoints.includes('palmers green')) {
      filteredServices.push({
        std: service.std,
        etd: service.etd,
        destination: service.destination[0]?.locationName,
        serviceId: service.serviceID
      });
    }
  }
  return filteredServices;
}

/*
 * Build a Google Maps walking directions URL for the user’s location to a station.
 */
function buildWalkingLink(userLat, userLon, destLat, destLon) {
  return `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLon}&destination=${destLat},${destLon}&travelmode=walking`;
}

/*
 * Main refresh logic.  Requests geolocation, finds nearest station, fetches trains, and updates UI.
 */
async function refreshHome() {
  const statusEl = document.getElementById('status');
  const resultsEl = document.getElementById('results');
  statusEl.textContent = 'Determining your location…';
  resultsEl.innerHTML = '';
  try {
    // Request geolocation; fallback to Winchmore Hill if denied
    const position = await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, {timeout: 8000});
    });
    const userLat = position.coords.latitude;
    const userLon = position.coords.longitude;
    const nearest = findNearestStation(userLat, userLon);
    statusEl.textContent = `Nearest station: ${nearest.name} (looking for trains to Palmers Green…)`;

    // Fetch departures that call at Palmers Green
    let services = await fetchTrainsForStation(nearest.code);
    // Fallback: if none found, try next‑nearest station (excluding the first)
    if (services.length === 0) {
      statusEl.textContent += ' – no direct trains found; checking next‑nearest station…';
      const sorted = stations
        .filter(st => st.code !== 'PAL' && st.code !== nearest.code)
        .map(st => ({st, dist: haversine(userLat, userLon, st.lat, st.lon)}))
        .sort((a,b) => a.dist - b.dist);
      for (const candidate of sorted) {
        services = await fetchTrainsForStation(candidate.st.code);
        if (services.length) {
          statusEl.textContent = `Nearest usable station: ${candidate.st.name}`;
          nearest.lat = candidate.st.lat;
          nearest.lon = candidate.st.lon;
          break;
        }
      }
    }

    if (services.length === 0) {
      statusEl.textContent = 'Sorry, no trains to Palmers Green found from nearby stations.';
      return;
    }

    // Build Google Maps link
    const walkLink = buildWalkingLink(userLat, userLon, nearest.lat, nearest.lon);

    // Render results
    const linkEl = document.createElement('a');
    linkEl.href = walkLink;
    linkEl.target = '_blank';
    linkEl.className = 'text-indigo-600 underline';
    linkEl.textContent = `Walk to ${nearest.name}`;
    resultsEl.appendChild(linkEl);

    const list = document.createElement('ul');
    list.className = 'divide-y divide-gray-200 mt-2';
    for (const svc of services.slice(0, 5)) {
      const li = document.createElement('li');
      li.className = 'py-2';
      li.textContent =
        `Departs ${svc.std} (expected ${svc.etd}) – destination ${svc.destination}`;
      list.appendChild(li);
    }
    resultsEl.appendChild(list);

  } catch (err) {
    statusEl.textContent = 'Unable to get location or train data: ' + err.message;
  }
}

// Immediately fetch on page load
refreshHome();
</script>
</body>
</html>
